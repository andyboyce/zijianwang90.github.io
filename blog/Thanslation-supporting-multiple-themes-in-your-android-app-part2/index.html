<!DOCTYPE html><html lang="default"><head><meta charset="UTF-8"><meta name="author" content="Zijian Wang"><meta name="desciption" content="暂无描述，哈"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>翻译：另你的Android应用支持多主题——下</title><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/carbon.css"><script defer="defer" src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js"></script><script defer="defer" src="//cdn.jsdelivr.net/jquery.pjax/1.9.5/jquery.pjax.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.css" type="text/css" media="screen"><script defer="defer" type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>var performFancybox = true;</script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/katex/0.5.0/katex.min.css"><script async="async" type="text/javascript" src="//cdn.jsdelivr.net/katex/0.5.0/katex.min.js"></script><script async="async" type="text/javascript" src="//cdn.jsdelivr.net/katex/0.5.0/contrib/auto-render.min.js"></script><script>var doRenderMath = 'katex';</script><script defer="defer" src="/js/carbon.js"></script></head><body><div id="container"><div id="banner"><h1 id="site-title"><a href="/">Cody.W的哈哈BLOG</a></h1><p id="site-subtitle">欢迎大家来讨论</p></div><div id="content"><div class="meta"><h2 class="article-title"><a href="/blog/Thanslation-supporting-multiple-themes-in-your-android-app-part2">翻译：另你的Android应用支持多主题——下</a></h2><div class="article-date"><a href="javascript:void(0);" class="extra-switch">2015-06-12</a></div></div><div class="extra"><span class="Tags">Tags: <a href="/tags/Android-Devlopment/">Android Devlopment</a>, <a href="/tags/Multiple-Theme/">Multiple Theme</a>.</span></div><div class="extra"><span class="Categories">Categories: None.</span></div><div class="article-content"><div class="gallery"></div><p><a href="http://www.hidroh.com/2015/02/25/support-multiple-themes-android-app-part-2/" target="_blank" rel="external">原文地址</a></p>
<p>在前面一片博文中，我们创建了一个Light主题并且为多主题切换做了一些准备工作。在这篇文章中，我们将基础创建另一套主题并且实现在代码中动态的切换。</p>
<p>理想状态下，如果我们将主题看作为一种配置，我们应该在theme-xxx资源文件夹下配置我们的资源文件，例如values-dark和values-light对应不同的主题。<strong>但是</strong>，这种配置方式在这边博文写成的时候还没有被实现。</p>
<p>那么我们该如何为不同的主题指定资源文件呢？如果我们观察在appcompat中资源文件是如何被放置的，我们就会对Android团队如何针对不同主题放置资源文件有了一个大概的认识。而<a href="https://play.google.com/store/apps/details?id=io.github.hidroh.materialistic" target="_blank" rel="external">Materialistic</a>正是采用这种方法。</p>
<h3 id="配置Theme">配置Theme</h3><p><strong>values/styles.xml</strong><br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;style <span class="property">name</span>=<span class="string">"AppTheme"</span> parent=<span class="string">"Theme.AppCompat.Light"</span>&gt;</span><br><span class="line">    &lt;!<span class="comment">-- 我们此前配置的主题 --&gt;</span></span><br><span class="line">    ...</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;style <span class="property">name</span>=<span class="string">"AppTheme.Dark"</span> parent=<span class="string">"Theme.AppCompat"</span>&gt;</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"colorPrimary"</span>&gt;@color/colorPrimaryInverse&lt;/<span class="property">item</span>&gt;</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"colorPrimaryDark"</span>&gt;@color/colorPrimaryDarkInverse&lt;/<span class="property">item</span>&gt;</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"colorAccent"</span>&gt;@color/colorAccentInverse&lt;/<span class="property">item</span>&gt;</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"android:textColorPrimary"</span>&gt;@color/textColorPrimaryInverse&lt;/<span class="property">item</span>&gt;</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"android:textColorSecondary"</span>&gt;@color/textColorSecondaryInverse&lt;/<span class="property">item</span>&gt;</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"android:textColorPrimaryInverse"</span>&gt;@color/textColorPrimary&lt;/<span class="property">item</span>&gt;</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"android:textColorSecondaryInverse"</span>&gt;@color/textColorSecondary&lt;/<span class="property">item</span>&gt;</span><br><span class="line">    ...</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>values/colors.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 此前配置的调色板 --&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">&lt;!-- 另外一套调色板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">color</span> <span class="attribute">name</span>=<span class="value">"colorPrimaryInverse"</span>&gt;</span>...<span class="tag">&lt;/<span class="title">color</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">color</span> <span class="attribute">name</span>=<span class="value">"colorPrimaryDarkInverse"</span>&gt;</span>...<span class="tag">&lt;/<span class="title">color</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">color</span> <span class="attribute">name</span>=<span class="value">"colorAccentInverse"</span>&gt;</span>...<span class="tag">&lt;/<span class="title">color</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>再次我们将dark主题命名为AppTheme.Dark，并且为了样式和颜色的一致性，我们让这个主题继承appcompat中的Theme.AppCompat主题（一个dark主题）。但是，因为我们的两套主题分别继承了两个不同的基本主题，他们就无法共享任何属性（正如在java中一个类不能继承两个或两个以上类一样）</p>
<p>这两套主题应该各自配置适当的属性，例如android:textColorPrimary对应dark主题的应该是明亮的颜色，而对应light主题应该是相对较暗的颜色。按照惯例，我们将第二套主题方案的颜色加以Inverse（译者：意思是反转转的颜色）后缀。</p>
<blockquote>
<p><strong>提示</strong><br>尝试在清单文件中手动切换主题来尝试你的主题，并注意哪些colors/style还需要被改动或者创建，在某些情况下你的颜色可能不需要更改。</p>
</blockquote>
<h3 id="不同主题的资源">不同主题的资源</h3><p>现在，我们应该已经有了一个不错的dark主题了，除了在一些细节上还需调整。例如action bar menu中items对应的drawables。一个dark主题必然是要用相对明亮的菜单图标，等等。为了让Android知道我们为不同的主题配置了不同的drawable资源，我们通过创建自定义属性的方式，通过对不同的主题指定该自定义属性，在把各自的drawable资源指定予这些属性（正如appcompat库中提供的那些自定义属性一样如colorPrimary）。</p>
<p><strong>values/attrs.xml</strong><br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;attr <span class="variable">name=</span><span class="string">"themedMenuStoryDrawable"</span> <span class="variable">format=</span><span class="string">"reference"</span> /&gt;</span><br><span class="line">&lt;attr <span class="variable">name=</span><span class="string">"themedMenuCommentDrawable"</span> <span class="variable">format=</span><span class="string">"reference"</span> /&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p><strong>values/styles.xml</strong><br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;style <span class="property">name</span>=<span class="string">"AppTheme"</span> parent=<span class="string">"Theme.AppCompat.Light"</span>&gt;</span><br><span class="line">    &lt;!<span class="comment">-- 原始主题 --&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"themedMenuStoryDrawable"</span>&gt;@drawable/ic_subject_white_24dp&lt;/<span class="property">item</span>&gt;</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"themedMenuCommentDrawable"</span>&gt;@drawable/ic_mode_comment_white_24dp&lt;/<span class="property">item</span>&gt;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;style <span class="property">name</span>=<span class="string">"AppTheme.Dark"</span> parent=<span class="string">"Theme.AppCompat"</span>&gt;</span><br><span class="line">    &lt;!<span class="comment">-- 第二主题 --&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"themedMenuStoryDrawable"</span>&gt;@drawable/ic_subject_black_24dp&lt;/<span class="property">item</span>&gt;</span><br><span class="line">    &lt;<span class="property">item</span> <span class="property">name</span>=<span class="string">"themedMenuCommentDrawable"</span>&gt;@drawable/ic_mode_comment_black_24dp&lt;/<span class="property">item</span>&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></p>
<p>类似的集成方式还可以被用在指定其他不同的资源属性到不同的主题上。但有一个小问题是在api21之前，这些属性中的drawable资源可能不能正常的显示，例如如果我们指定了一个多个颜色的layer-list类型的drawable，那么他们的值必须被修正，修正方法可以看这个<a href="https://github.com/google/iosched/commit/dd7ed72a7eb2d223203db079bd99d31c6ef3061e" target="_blank" rel="external">Google I/O 2014应用的一次提交</a>。</p>
<p>另一个避免不同资源文件对应不同主题的方式是使用tint属性，<a href="http://blog.danlew.net/2014/08/18/fast-android-asset-theming-with-colorfilter/" target="_blank" rel="external">Dan Lew的这篇博客</a>展示了如何针对不同的api等级使用tint。个人来讲我更愿意让我的Java代码和视图逻辑尽可能的拆分，所以我选择为不同的theme使用不同的drawable资源。</p>
<h3 id="动态切换">动态切换</h3><p>现在我们的两个主题应该已经准备完毕了，接下来就是能够让我们的用户在应用中根据他们的喜好动态的切换主题。我们的实现方式是利用SharedPreferences，例如在其中pref_dark_theme属性来决定显示什么样的主题。主题应该被应用在所有的Activity上，并且在所有的View会创建之前执行，所以我们只需要在onCreate()中编写我们的逻辑即可。</p>
<p><strong>BaseActivity.java</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">ActionBarActivity</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (PreferenceManager.getDefaultSharedPreferences(<span class="keyword">this</span>)</span><br><span class="line">                .getBoolean(<span class="string">"pref_dark_theme"</span>), <span class="keyword">false</span>)) &#123;</span><br><span class="line">            setTheme(R.style.AppTheme_Dark);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于我们的应用已经被指定了Light的默认主题，所以我们需要先检查默认的配置是否已经被改成了dark主题。而这个逻辑被放在BaseActivity中也是为了所有activity中的复用。</p>
<p>注意这种方式只应用于没有处于后台栈（back stack）中的Activity（译者：应该是指在我们改变过主题后，处于后台的activity不会也就此改变主题，因为不会再触发onCreate()）。而对于那些已经在当前栈中存在的Activity，他们仍然会展现之前的主题，因为回退到这个Activity只会出发onResume()。针对不同的产品需求，代码的集成方式可能会不同，一种思路可以是清除栈中的activity或者重新创建每个Activity以便让他们的主题变换。再这里我们只是在主题切换后简单的清除任务栈并重启activity。</p>
<p><strong>SettingsFragment.java</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SettingsFragment</span> <span class="keyword">extends</span> <span class="title">PreferenceFragment</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        mListener = <span class="keyword">new</span> SharedPreferences.OnSharedPreferenceChangeListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSharedPreferenceChanged</span><span class="params">(SharedPreferences sharedPreferences, String key)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!key.equals(<span class="string">"pref_dark_theme"</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                getActivity().finish();</span><br><span class="line">                <span class="keyword">final</span> Intent intent = getActivity().getIntent();</span><br><span class="line">                intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | IntentCompat.FLAG_ACTIVITY_CLEAR_TASK);</span><br><span class="line">                getActivity().startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p>至此，我们已经完成了两个不同的主题在一个应用中的集成，更完整的代码可以移步<a href="https://github.com/hidroh/materialistic" target="_blank" rel="external">hidroh/materialistic</a>的Github查看！</p>
</div><nav class="pagination"><a id="left-navigator" href="/blog/Translation-PSA-fix-MultiDex-build-crashes/">翻译：如何修复编译时的MultiDex崩溃</a><a id="right-navigator" href="/blog/Thanslation-supporting-multiple-themes-in-your-android-app-part1/">翻译：另你的Android应用支持多主题——上</a></nav></div><nav id="footer"><ul id="footer-links"><li><a href="/about">About</a></li><li><a href="/archives">Archives</a></li><li><a href="/atom.xml">RSS</a></li><li><a href="https://icylogic.net" class="out-site">Theme.Carbon</a></li><li><a href="https://github.com/hexojs/hexo" class="out-site">Hexo</a></li></ul></nav></div></body></html>