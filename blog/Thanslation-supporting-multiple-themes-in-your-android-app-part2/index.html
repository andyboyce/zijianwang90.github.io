<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>翻译：另你的Android应用支持多主题——下 | Cody.W的哈哈BLOG</title>
  <meta name="author" content="Zijian Wang">
  
  <meta name="description" content="暂无描述，哈">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="翻译：另你的Android应用支持多主题——下"/>
  <meta property="og:site_name" content="Cody.W的哈哈BLOG"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Cody.W的哈哈BLOG" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

  
<script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fac7581aaee317d2fe1f7a0fc8d1f214";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Cody.W的哈哈BLOG</a></h1>
  <h2><a href="/">欢迎大家来讨论</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-06-12T15:44:52.000Z"><a href="/blog/Thanslation-supporting-multiple-themes-in-your-android-app-part2/">2015-06-12</a></time>
      
      
  
    <h1 class="title">翻译：另你的Android应用支持多主题——下</h1>
  

    </header>
    <div class="entry">
      
        <p><a href="http://www.hidroh.com/2015/02/25/support-multiple-themes-android-app-part-2/" target="_blank" rel="external">原文地址</a></p>
<p>在前面一片博文中，我们创建了一个Light主题并且为多主题切换做了一些准备工作。在这篇文章中，我们将基础创建另一套主题并且实现在代码中动态的切换。</p>
<p>理想状态下，如果我们将主题看作为一种配置，我们应该在<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#37027;&#20040;&#25105;&#20204;&#35813;&#22914;&#20309;&#20026;&#19981;&#21516;&#30340;&#20027;&#39064;&#25351;&#23450;&#36164;&#28304;&#25991;&#20214;&#21602;&#65311;&#22914;&#26524;&#25105;&#20204;&#35266;&#23519;&#22312;appcompat&#20013;&#36164;&#28304;&#25991;&#20214;&#26159;&#22914;&#20309;&#34987;&#25918;&#32622;&#30340;&#65292;&#25105;&#20204;&#23601;&#20250;&#23545;Android&#22242;&#38431;&#22914;&#20309;&#38024;&#23545;&#19981;&#21516;&#20027;&#39064;&#25918;&#32622;&#36164;&#28304;&#25991;&#20214;&#26377;&#20102;&#19968;&#20010;&#22823;&#27010;&#30340;&#35748;&#35782;&#12290;&#32780;[Materialistic][2]&#27491;&#26159;&#37319;&#29992;&#36825;&#31181;&#26041;&#27861;&#12290;&#10;&#10;###&#37197;&#32622;Theme&#10;&#10;**values/styles.xml**</span><br></pre></td></tr></table></figure></p>
<style name="AppTheme" parent="Theme.AppCompat.Light">
    <!-- 我们此前配置的主题 -->
    ...
</style>

<style name="AppTheme.Dark" parent="Theme.AppCompat">
    <item name="colorPrimary">@color/colorPrimaryInverse</item>
    <item name="colorPrimaryDark">@color/colorPrimaryDarkInverse</item>
    <item name="colorAccent">@color/colorAccentInverse</item>
    <item name="android:textColorPrimary">@color/textColorPrimaryInverse</item>
    <item name="android:textColorSecondary">@color/textColorSecondaryInverse</item>
    <item name="android:textColorPrimaryInverse">@color/textColorPrimary</item>
    <item name="android:textColorSecondaryInverse">@color/textColorSecondary</item>
    ...
</style>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">values/colors<span class="built_in">.</span><span class="built_in">xml</span></span><br></pre></td></tr></table></figure>

<!-- 此前配置的调色板 -->
...
<!-- 另外一套调色板 -->
<color name="colorPrimaryInverse">...</color>
<color name="colorPrimaryDarkInverse">...</color>
<color name="colorAccentInverse">...</color>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">再次我们将dark主题命名为<span class="escape">``</span><span class="escape">`A</span>ppTheme.Dark<span class="escape">``</span><span class="escape">`，</span>并且为了样式和颜色的一致性，我们让这个主题继承appcompat中的<span class="escape">``</span><span class="escape">`T</span>heme.AppCompat<span class="escape">``</span><span class="escape">`主</span>题（一个dark主题）。但是，因为我们的两套主题分别继承了两个不同的基本主题，他们就无法共享任何属性（正如在java中一个类不能继承两个或两个以上类一样）</span><br><span class="line"></span><br><span class="line"><span class="label">这两套主题应该各自配置适当的属性，例如```android:</span>textColorPrimary<span class="escape">``</span><span class="escape">`对</span>应dark主题的应该是明亮的颜色，而对应light主题应该是相对较暗的颜色。按照惯例，我们将第二套主题方案的颜色加以Inverse（译者：意思是反转转的颜色）后缀。</span><br><span class="line"></span><br><span class="line">&gt; **提示**</span><br><span class="line">尝试在清单文件中手动切换主题来尝试你的主题，并注意哪些colors/style还需要被改动或者创建，在某些情况下你的颜色可能不需要更改。</span><br><span class="line"></span><br><span class="line">###不同主题的资源</span><br><span class="line"></span><br><span class="line">现在，我们应该已经有了一个不错的dark主题了，除了在一些细节上还需调整。例如action bar menu中items对应的drawables。一个dark主题必然是要用相对明亮的菜单图标，等等。为了让Android知道我们为不同的主题配置了不同的drawable资源，我们通过创建自定义属性的方式，通过对不同的主题指定该自定义属性，在把各自的drawable资源指定予这些属性（正如appcompat库中提供的那些自定义属性一样如<span class="escape">``</span><span class="escape">`c</span>olorPrimary<span class="escape">``</span><span class="escape">`）</span>。</span><br><span class="line"></span><br><span class="line">**values/attrs.xml**</span><br></pre></td></tr></table></figure>

<attr name="themedMenuStoryDrawable" format="reference">
<attr name="themedMenuCommentDrawable" format="reference">
...
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">*</span><span class="keyword">*</span>values/styles.xml<span class="keyword">*</span><span class="keyword">*</span></span><br></pre></td></tr></table></figure>

<style name="AppTheme" parent="Theme.AppCompat.Light">
    <!-- 原始主题 -->
    ...
    <item name="themedMenuStoryDrawable">@drawable/ic_subject_white_24dp</item>
    <item name="themedMenuCommentDrawable">@drawable/ic_mode_comment_white_24dp</item>
</style>

<p><style name="AppTheme.Dark" parent="Theme.AppCompat"><br>    <!-- 第二主题 --><br>    …<br>    <item name="themedMenuStoryDrawable">@drawable/ic_subject_black_24dp</item><br>    <item name="themedMenuCommentDrawable">@drawable/ic_mode_comment_black_24dp</item><br></style><br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">类似的集成方式还可以被用在指定其他不同的资源属性到不同的主题上。但有一个小问题是在api21之前，这些属性中的drawable资源可能不能正常的显示，例如如果我们指定了一个多个颜色的<span class="code">```</span>layer-list<span class="code">```</span>类型的drawable，那么他们的值必须被修正，修正方法可以看这个[<span class="link_label">Google I/O 2014应用的一次提交</span>][<span class="link_reference">3</span>]。</span><br><span class="line"></span><br><span class="line">另一个避免不同资源文件对应不同主题的方式是使用<span class="code">```</span>tint<span class="code">```</span>属性，[<span class="link_label">Dan Lew的这篇博客</span>][<span class="link_reference">4</span>]展示了如何针对不同的api等级使用<span class="code">```</span>tint<span class="code">```</span>。个人来讲我更愿意让我的Java代码和视图逻辑尽可能的拆分，所以我选择为不同的theme使用不同的drawable资源。</span><br><span class="line"></span><br><span class="line"><span class="header">###动态切换</span></span><br><span class="line"></span><br><span class="line">现在我们的两个主题应该已经准备完毕了，接下来就是能够让我们的用户在应用中根据他们的喜好动态的切换主题。我们的实现方式是利用<span class="code">```</span>SharedPreferences<span class="code">```</span>，例如在其中<span class="code">```</span>pref<span class="emphasis">_dark_</span>theme<span class="code">```</span>属性来决定显示什么样的主题。主题应该被应用在所有的Activity上，并且在所有的View会创建之前执行，所以我们只需要在<span class="code">```</span>onCreate()<span class="code">```</span>中编写我们的逻辑即可。</span><br><span class="line"></span><br><span class="line"><span class="strong">**BaseActivity.java**</span></span><br><span class="line"><span class="code">```</span>java</span><br><span class="line">public abstract class BaseActivity extends ActionBarActivity &#123;</span><br><span class="line"><span class="code">    @Override</span></span><br><span class="line"><span class="code">    protected void onCreate(Bundle savedInstanceState) &#123;</span></span><br><span class="line"><span class="code">        if (PreferenceManager.getDefaultSharedPreferences(this)</span></span><br><span class="line"><span class="code">                .getBoolean("pref_dark_theme"), false)) &#123;</span></span><br><span class="line"><span class="code">            setTheme(R.style.AppTheme_Dark);</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">        super.onCreate(savedInstanceState);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于我们的应用已经被指定了Light的默认主题，所以我们需要先检查默认的配置是否已经被改成了dark主题。而这个逻辑被放在BaseActivity中也是为了所有activity中的复用。</p>
<p>Note that this approach will only apply theme for activities that are not in the back stack. For those that are already in current stack, they will still exhibit previous theme, as going back will only trigger onResume(). Depends on product requirements, the implementation to handle these ‘stale’ screens can be as simple as clearing the back stack, or restarting every single activity in the back stack upon preference change. Here we simply clear back stack and restart current activity upon theme change.</p>
<p>注意这种方式只应用于没有处于后台栈（back stack）中的Activity（译者：应该是指在我们改变过主题后，处于后台的activity不会也就此改变主题，因为不会再触发onCreate()）。而对于那些已经在当前栈中存在的Activity，他们仍然会展现之前的主题，因为回退到这个Activity只会出发<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;**SettingsFragment.java**&#10;```java&#10;public class SettingsFragment extends PreferenceFragment &#123;&#10;    ...&#10;&#10;    @Override&#10;    public void onActivityCreated(Bundle savedInstanceState) &#123;&#10;        super.onActivityCreated(savedInstanceState);&#10;        mListener = new SharedPreferences.OnSharedPreferenceChangeListener() &#123;&#10;            @Override&#10;            public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) &#123;&#10;                if (!key.equals(&#34;pref_dark_theme&#34;)) &#123;&#10;                    return;&#10;                &#125;&#10;&#10;                getActivity().finish();&#10;                final Intent intent = getActivity().getIntent();&#10;                intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | IntentCompat.FLAG_ACTIVITY_CLEAR_TASK);&#10;                getActivity().startActivity(intent);&#10;            &#125;&#10;        &#125;;&#10;    &#125;&#10;&#10;    ...</span><br></pre></td></tr></table></figure></p>
<p>So that’s it. Now we have an app with two polished themes for even the most picky users! Head over to hidroh/materialistic GitHub repository to checkout complete implementation!<br>至此，我们已经完成了两个不同的主题在一个应用中的集成，更完整的代码可以移步<a href="https://github.com/hidroh/materialistic" target="_blank" rel="external">hidroh/materialistic</a>的Github查看！</p>
</attr></attr>
      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/Android-Devlopment/">Android Devlopment</a>, <a href="/tags/Multiple-Theme/">Multiple Theme</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="blog/Thanslation-supporting-multiple-themes-in-your-android-app-part2/" data-title="翻译：另你的Android应用支持多主题——下" data-url="http://zijianwang.xyz/blog/Thanslation-supporting-multiple-themes-in-your-android-app-part2/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"zijianwang"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:zijianwang.xyz">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/Android/">Android</a><small>3</small></li>
  
    <li><a href="/tags/Android-Devlopment/">Android Devlopment</a><small>2</small></li>
  
    <li><a href="/tags/Android-M/">Android M</a><small>1</small></li>
  
    <li><a href="/tags/Auto-Backup/">Auto Backup</a><small>1</small></li>
  
    <li><a href="/tags/Multiple-Theme/">Multiple Theme</a><small>2</small></li>
  
    <li><a href="/tags/Retrofit/">Retrofit</a><small>2</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Zijian Wang
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>