<!DOCTYPE html><html lang="default"><head><meta charset="UTF-8"><meta name="author" content="Zijian Wang"><meta name="desciption" content="暂无描述，哈"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>在RecyclerView中实现拖动和滑动 - Part 1</title><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/carbon.css"><script defer="defer" src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js"></script><script defer="defer" src="//cdn.jsdelivr.net/jquery.pjax/1.9.5/jquery.pjax.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.css" type="text/css" media="screen"><script defer="defer" type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>var performFancybox = true;</script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/katex/0.5.0/katex.min.css"><script async="async" type="text/javascript" src="//cdn.jsdelivr.net/katex/0.5.0/katex.min.js"></script><script async="async" type="text/javascript" src="//cdn.jsdelivr.net/katex/0.5.0/contrib/auto-render.min.js"></script><script>var doRenderMath = 'katex';</script><script defer="defer" src="/js/carbon.js"></script></head><body><div id="container"><div id="banner"><h1 id="site-title"><a href="/">Cody.W的哈哈BLOG</a></h1><p id="site-subtitle">欢迎大家来讨论</p></div><div id="content"><div class="meta"><h2 class="article-title"><a href="/blog/Translation-drag-and-swipe-with-recyclerview-part1">在RecyclerView中实现拖动和滑动 - Part 1</a></h2><div class="article-date"><a href="javascript:void(0);" class="extra-switch">2015-08-09</a></div></div><div class="extra"><span class="Tags">Tags: <a href="/tags/Android/">Android</a>, <a href="/tags/Drag-and-Swipe/">Drag and Swipe</a>, <a href="/tags/Recycler-View/">Recycler View</a>.</span></div><div class="extra"><span class="Categories">Categories: None.</span></div><div class="article-content"><div class="gallery"></div><h1 id="原文地址在此"><a href="https://medium.com/@ipaulpro/drag-and-swipe-with-recyclerview-b9456d2b1aaf" target="_blank" rel="external">原文地址在此</a></h1><p><img src="http://7xj95v.com1.z0.glb.clouddn.com/dragandswipe.gif" alt="效果图"></p>
<p>有很多的文章，第三方库和实例都讲解了在Android开发中如何在RecyclerView中实现“拖动”和“侧滑”。但大多数还在使用老的<a href="http://developer.android.com/guide/topics/ui/drag-drop.html" target="_blank" rel="external">View.OnDragListener</a>，或者Roman Nurik的<a href="https://github.com/romannurik/Android-SwipeToDismiss" target="_blank" rel="external">SwipeToDismiss</a>方法。尽管现在已经有了很多新的API，但很多人还依赖于GestureDetectors和onInterceptTouchEvent，集成方法过于复杂。但其实有一个<strong>非常简单</strong>的办法来实现拖动和侧滑效果，只需要一个Android Support Library中的一个类：</p>
<blockquote>
<p><a href="https://developer.android.com/reference/android/support/v7/widget/helper/ItemTouchHelper.html" target="_blank" rel="external">ItemTouchHelper</a></p>
</blockquote>
<p>ItemTouchHelper是一个非常强大的工具类，它可以让你在RecyclerView中轻松的实现拖动和侧滑的效果。它是一个<a href="https://developer.android.com/reference/android/support/v7/widget/RecyclerView.ItemDecoration.html" target="_blank" rel="external">RecyclerView.ItemDecoration</a>的子类，这意味着它可以很容易的添加到任何已存在的LayoutManager和Adapter。它还可以配合动画，为你的条目提供拖动，滑动，以及下落的动画等等。在这篇文章中，我会向大家简单展示ItemTouchHelper的使用，在后面的系列文章中，我会展开并且探索更多的功能。</p>
<h1 id="懒得看了">懒得看了</h1><p>如果想直接看源代码，猛击<a href="https://github.com/iPaulPro/Android-ItemTouchHelper-Demo" target="_blank" rel="external">此处Github</a>跳转，第一次<a href="https://github.com/iPaulPro/Android-ItemTouchHelper-Demo/tree/d8d85c32d579f19718b9bbb97f7a1bda0e616f1fRecyclerView.ItemDecoration.html" target="_blank" rel="external">Commit</a>对应此篇文章，Demo api请去<a href="https://github.com/iPaulPro/Android-ItemTouchHelper-Demo/releases" target="_blank" rel="external">这里下载</a>。</p>
<h1 id="配置">配置</h1><p>首先我们当然需要的是声明RecyclerView的依赖：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">'com.android.support:recyclerview-v7:22.2.0'</span></span><br></pre></td></tr></table></figure></p>
<p>ItemTouchHelper可以运用在几乎所有的RecyclerView.Adapter和LayoutManager上，但是这篇文章的讲解会基于<a href="https://gist.github.com/iPaulPro/2216ea5e14818056cfcc" target="_blank" rel="external">这里面</a>中的代码。</p>
<h1 id="使用ItemTouchHelper，以及ItemTouchHelper-Callback">使用ItemTouchHelper，以及ItemTouchHelper.Callback</h1><p>为了使用ItemTouchHelper，我们需要创建一个<a href="https://developer.android.com/reference/android/support/v7/widget/helper/ItemTouchHelper.Callback.htmler-Demo/releases" target="_blank" rel="external">ItemTouchHelper.Callback</a>。这是一个可以让你监听“移动”和“滑动”等事件的接口。他还允许你控制View的选择状态，以及替换默认的动画。当然你可以使用<a href="https://developer.android.com/reference/android/support/v7/widget/helper/ItemTouchHelper.SimpleCallback.html" target="_blank" rel="external">SimpleCallback</a>这个Helper类来简单的集成这些回调，但是出于学习的目的，我们还是自己创建一个。</p>
<p>为了实现拖动侧滑等功能我们必须复写一下回调：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">getMovementFlags</span><span class="params">(RecyclerView, ViewHolder)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">onMove</span><span class="params">(RecyclerView, ViewHolder, ViewHolder)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">onSwiped</span><span class="params">(ViewHolder, int)</span></span></span><br></pre></td></tr></table></figure></p>
<p>接下来复写以下两个回调：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">isLongPressDragEnabled</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">isItemViewSwipeEnabled</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure></p>
<p>下面我们来逐个讲解每个回调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMovementFlags</span><span class="params">(RecyclerView recyclerView, RecyclerView.ViewHolder viewHolder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dragFlags = ItemTouchHelper.UP | ItemTouchHelper.DOWN;</span><br><span class="line">    <span class="keyword">int</span> swipeFlags = ItemTouchHelper.START | ItemTouchHelper.END;</span><br><span class="line">    <span class="keyword">return</span> makeMovementFlags(dragFlags, swipeFlags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ItemTouchHelper可以让我们很简单的判断事件的方向，我们必须复写<strong>getMovementFlags()</strong>方法来判断我们拖动或者滑动的方向。然后使用<strong>ItemTouchHelper.makeMovementFlags(int, int)</strong>方法去创建返回的标志。在此我们为拖动和侧滑都开启了双方向滑动。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLongPressDragEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ItemTouchHelper允许我们只拖动而不侧滑（或者反过来），所以我们必须明确指出我们想要哪个功能。为了能够在长按条目后开启拖动事件，我们必须在<strong>isLongPressDragEnabled()</strong>方法中返回true。或者，我们也可以通过调用<strong>ItemTouchHelper.startDrag(RecyclerView.ViewHolder)</strong>启动拖动，这在后面的文章中会涉及到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isItemViewSwipeEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<strong>isItemViewSwipeEnabled()</strong>中返回true会允许当前条目从任何位置开启侧滑功能。或者，我们可以通过调用<strong>ItemTouchHelper.startSwipe(RecyclerView.ViewHolder)</strong>去启动侧滑功能。</p>
<p>后面两个，复写<strong>onMove()</strong>和<strong>onSwiped()</strong>的目的是能能够在事件变化后得到通知。所以我们还需要一个回调接口用于在传递这些事件的回调。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemTouchHelperAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemMove</span><span class="params">(<span class="keyword">int</span> fromPosition, <span class="keyword">int</span> toPosition)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemDismiss</span><span class="params">(<span class="keyword">int</span> position)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://gist.github.com/iPaulPro/5d43325ac7ae579760a9" target="_blank" rel="external">接口源码在这里</a></p>
<p>有了上面定义的接口，我们就可以简单的让我们的<a href="https://gist.github.com/iPaulPro/2216ea5e14818056cfcc#file-recyclerlistadapter-java" target="_blank" rel="external">RecyclerListAdapter</a>去实现这个接口了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecyclerListAdapter</span> <span class="keyword">extends</span></span><br><span class="line">        <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">ItemViewHolder</span>&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title">ItemTouchHelperAdapter</span> </span>&#123;</span><br><span class="line"><span class="comment">// ... code from gist</span></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemDismiss</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    mItems.remove(position);</span><br><span class="line">    notifyItemRemoved(position);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onItemMove</span><span class="params">(<span class="keyword">int</span> fromPosition, <span class="keyword">int</span> toPosition)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fromPosition &lt; toPosition) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = fromPosition; i &lt; toPosition; i++) &#123;</span><br><span class="line">            Collections.swap(mItems, i, i + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = fromPosition; i &gt; toPosition; i--) &#123;</span><br><span class="line">            Collections.swap(mItems, i, i - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    notifyItemMoved(fromPosition, toPosition);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这里切记我们要调<strong>用notifyItemRemoved()</strong>和<strong>notifyItemMoved()</strong>方法，以便我们的Adapter知道这些变化。同时我们还要切记在View位置变换之后对数据源的数据进行切换。</p>
<p>处理完回调接口和Adapter，我们可以回到<strong>SimpleItemTouchHelperCallback</strong>类，我们在构造函数中传入一个ItemTouchHelperAdapter实例以便我们能够调用接口中的<strong>onMove()</strong>和<strong>onSwiped()</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ItemTouchHelperAdapter mAdapter;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SimpleItemTouchHelperCallback</span><span class="params">(ItemTouchHelperAdapter adapter)</span> </span>&#123;</span><br><span class="line">    mAdapter = adapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完后在相应位置调用回调方法通知adapter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onMove</span><span class="params">(RecyclerView recyclerView, RecyclerView.ViewHolder viewHolder, RecyclerView.ViewHolder target)</span> </span>&#123;</span><br><span class="line">    mAdapter.onItemMove(viewHolder.getAdapterPosition(),</span><br><span class="line">            target.getAdapterPosition());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSwiped</span><span class="params">(RecyclerView.ViewHolder viewHolder, <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">    mAdapter.onItemDismiss(viewHolder.getAdapterPosition());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，SimpleItemTouchHelperCallback类看起来是这样的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleItemTouchHelperCallback</span> <span class="keyword">extends</span> <span class="title">ItemTouchHelper</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ItemTouchHelperAdapter mAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleItemTouchHelperCallback</span><span class="params">(ItemTouchHelperAdapter adapter)</span> </span>&#123;</span><br><span class="line">        mAdapter = adapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLongPressDragEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isItemViewSwipeEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMovementFlags</span><span class="params">(RecyclerView recyclerView, ViewHolder viewHolder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> dragFlags = ItemTouchHelper.UP | ItemTouchHelper.DOWN;</span><br><span class="line">        <span class="keyword">int</span> swipeFlags = ItemTouchHelper.START | ItemTouchHelper.END;</span><br><span class="line">        <span class="keyword">return</span> makeMovementFlags(dragFlags, swipeFlags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onMove</span><span class="params">(RecyclerView recyclerView, ViewHolder viewHolder, ViewHolder target)</span> </span>&#123;</span><br><span class="line">        mAdapter.onItemMove(viewHolder.getAdapterPosition(), target.getAdapterPosition());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSwiped</span><span class="params">(ViewHolder viewHolder, <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">        mAdapter.onItemDismiss(viewHolder.getAdapterPosition());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>好了，我们的Callback类也搞定了，现在我们可以创建ItemTouchHelper并且将Callback赋予其中，最后调用<strong>attachToRecyclerView(RecyclerView)</strong>（<a href="https://gist.github.com/iPaulPro/2216ea5e14818056cfcc#file-mainfragment-java" target="_blank" rel="external">例子在这里</a>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ItemTouchHelper.Callback callback = <span class="keyword">new</span> SimpleItemTouchHelperCallback(adapter);</span><br><span class="line">ItemTouchHelper touchHelper = <span class="keyword">new</span> ItemTouchHelper(callback);</span><br><span class="line">touchHelper.attachToRecyclerView(recyclerView);</span><br></pre></td></tr></table></figure>
<p>接下来当我们运行的时候，效果应该是这样的：<br><img src="http://7xj95v.com1.z0.glb.clouddn.com/dragandswipe2.gif" alt="效果图2"></p>
<h1 id="结论">结论</h1><p>以上是针对集成ItemTouchHelper的一个最简单的实践。我们也会发现，对于实现类似这种的功能，我们未必要借助第三方库。在后面的章节中，我们会进一步针对条目的外观以及效果做文章。</p>
<h1 id="下一部分">下一部分</h1></div><nav class="pagination"><a id="right-navigator" href="/blog/Android-dev-recyclerview-replace-gridview/">使用RecyclerView打造类支付宝首页的GridView效果</a></nav></div><nav id="footer"><ul id="footer-links"><li><a href="/about">About</a></li><li><a href="/archives">Archives</a></li><li><a href="/atom.xml">RSS</a></li><li><a href="https://icylogic.net" class="out-site">Theme.Carbon</a></li><li><a href="https://github.com/hexojs/hexo" class="out-site">Hexo</a></li></ul></nav></div></body></html>