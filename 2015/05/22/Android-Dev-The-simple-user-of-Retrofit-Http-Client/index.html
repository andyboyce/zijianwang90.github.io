<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Andriod集成Retrofit网络请求库指南指南 | Cody.W的终极BLOG</title>
  <meta name="author" content="Zijian Wang">
  
  <meta name="description" content="暂无描述，哈">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Andriod集成Retrofit网络请求库指南指南"/>
  <meta property="og:site_name" content="Cody.W的终极BLOG"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Cody.W的终极BLOG" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Cody.W的终极BLOG</a></h1>
  <h2><a href="/">欢迎大家来讨论</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-05-22T23:49:54.000Z"><a href="/2015/05/22/Android-Dev-The-simple-user-of-Retrofit-Http-Client/">2015-05-22</a></time>
      
      
  
    <h1 class="title">Andriod集成Retrofit网络请求库指南指南</h1>
  

    </header>
    <div class="entry">
      
        <p>近期我在我们的项目中大量的集成了Retrofit网络请求框架，经过了对Retrofit几天的了解，感觉这个库确实很强大很好用。</p>
<p>而鉴于目前网上一些中文Retrofit的指南我个人认为都不是很详尽（大多只是将官方文档用中文翻译了一下），即便是Retrofit官方指南也没有把大家可能常用到的API解释详尽。</p>
<p>所以本文意在给大家更加详细的讲解如何简单的使用Retrofit。鉴于本人技术有限，对Retrofit的实现原理以及源码等分析做的并不透彻，只是向大家简要介绍Retrofit的使用，使得像我一样的新手能够快速的上手入门。也希望大家向我提出宝贵的意见。</p>
<hr>
<p>有关更多API文档的查阅请大家到<a href="http://square.github.io/retrofit/" target="_blank" rel="external">Retrofit官网</a>查看。</p>
<p>以下，我将以我们的产品“<a href="http://sj.qq.com/myapp/detail.htm?apkName=com.cxtimes.zhixue" target="_blank" rel="external">知学</a>”中所用到的一些网络请求来为大家阐述Retrofit的简单使用。</p>
<p>对Retrofit而言，有两个类是非常关键的，那就是RestAdapter和我们自定义的接口（在知学中叫做ZhixueApi），前者的的作用有很多，但我们我们必然会用到的就是<strong>指定我们请求网络的主域名</strong>。而后者则负责封装我们在项目中要用到的每一个接口。</p>
<p>首先我们来简单了解下关于ZhixueApi的定义。在这个类中，我会介绍我们用到的几种提交方式以及参数的拼装形式。</p>
<p>另外，在我们的应用中并没有用到GET提交方式，有关的信息在官方指南中也阐述的比较清晰，本文便不在单独讨论GET提交方式。</p>
<pre><code>
public interface ZhixueApi {

    //1. 无参数post请求, 这里的Coupon则是用来解析服务器返回Json字符串的javabean类, Retrofit默认使用Gson解析
    @POST("/interface/xxxxxx")
    void getCouponList(Callback&lt;Coupon&gt; reponse);

    //2. 一个或几个参数的post请求
    // 注: 如果使用官方指南中提到的@Query和@QueryMap对参数进行封装, 那么默认会将参数拼到URL之中
    // 首先并不建议将参数拼如URL, 其次由于编码原因, 如果选择采用@Query或者@QueryMap类型的注解, 则参数中必然不能有中文
    // 其次如果使用@Query或者@QueryMap, 也就不能使用@FormUrlEncoded注解, 否则参数会消失
    // 如果使用了@FormUrlEncoded注解, 则必须使用@Field或者@FieldMap注解来作为参数
    @FormUrlEncoded
       @POST("/interface/xxxxxx")
       void getCourseList(@Field("userId") String userId, @Field("orderId") String orderId, Callback&lt;Coupon&gt; response);

    //3. 通过@FieldMap注解来封装参数
    //注: 如果你的参数只有一个或者两三个, 那么用@Field就基本足够了, 但如果你的参数非常之多, 七八个甚至十几个
    //那么我们就可以用一个Map去封装, 通过key-value的形式封装好Map对象后再传入, 代码会相对整洁, 在做参数传递的时候也不至于乱套
    @FormUrlEncoded
    @POST("/interface/xxxxxx")
       void getCourseList(@FieldMap Map&lt;String,String&gt; paramsMap, Callback&lt;Coupon&gt; response);

    //4. 提交multipart请求
    // 注: 如果我们要提交用户拍的的照片, 或者是录好的语音, 那么我们就要用到@Multipart这个注解了
    // 在使用Multipart的时候, 注意参数的注解必须是@Part或者@PartMap 
    // @PartMap和上面的@FieldMap类似, 都是通过Map封装好参数, 就不过多解释了.
    @Multipart
       @POST("/interface/photoUpload_servlet")
       void submitUserPhoto(@Part("userId") String userId, @Part("file") TypedFile file, Callback&lt;Coupon&gt; response response);
}

</code></pre>

<p>而对于上传文件, 我们需要将我们所需上传的File文件转换成TypedFile形式, 在Retrofit中也很简单</p>
<pre><code>
//首先定义一个mimeType类型, 如果我要上传的是一张图片, 就按如下定义
String mimeType = "image/jpg";
//String mimeType = "audio/m4a";//如果是m4a的声音文件, 就这么定义
TypedFile typedFile = new TypedFile(mimeType, file);//调用这个方法将文件转为TypedFile形势, 传参上传即可

</code></pre>

<p>以下这个类是我封装的ZhixueApiUtil，作用是在每次请求接口的时候能够快速的拿到ZhixueApi的实例，所以我在此设计了一个简单的单例模式。</p>
<pre><code>
public class ZhixueApiUtil {

    private static ZhixueApiUtil mInstance;
    //此前定义的接口的实例
    private ZhixueApi zhixueApi;
    //我们的主域名
    private static final String HOST = "http://111.111.111.111";
    //构造函数
    private ZhixueApiUtil() {
        //在构造函数中我们要通过实例化RestAdapter拿到我们的ZhixueApi
        //注: setRequestInterceptor()在这里是为了在请求头中加入设备信息, 方便我们后台的调试
        RestAdapter restAdapter = new RestAdapter.Builder().setRequestInterceptor(defaultInterceptor).setEndpoint(HOST).build();
        zhixueApi = restAdapter.create(ZhixueApi.class);
    }

    //一个简单的单例
    public static ZhixueApiUtil getInstance() {
        if (mInstance == null) {
            mInstance = new ZhixueApiUtil();
        }
        return mInstance;
    }

    public ZhixueApi getZhixueApi() {
        return zhixueApi;
    }

    //在这里我们还定义了一个RequestInterceptor, 作用是在请求头中拼入一些信息方便我们后台的调试
    //否则请求头中就只会出现okhttp 2.2.0的字样(Retrofit默认是直接使用OkhttpClient的)
    RequestInterceptor defaultInterceptor = new RequestInterceptor() {
        @Override
        public void intercept(RequestFacade request) {
            request.addHeader("User-Agent", "some code here");
        }
    };
}
</code></pre>

<p>而当我们手握这两个类的时候, 请求接口就会变得异常的简单</p>
<pre><code>
//例如

ZhixueApiUtil.getInstance().getZhixueApi().getCourseList(paramsMap, new Callback&lt;Coupon&gt;(){

    @Override
    public void success(Coupon coupn, Response response) {
        //在这里Json已经通过Retrofit中含有的Gson包为我们解析好了, 直接拿出来用就好了!
        ...
    }

    @Override
    public void failure(RetrofitError error) {
        Log.d(TAG, error.getMessage());
        ...
    }
});
</code></pre>

<h3 id="到这里，相信大家已经能够基本使用Retrofit了，本人代码经验尚浅，文中有什么不足希望大家多提宝贵意见。">到这里，相信大家已经能够基本使用Retrofit了，本人代码经验尚浅，文中有什么不足希望大家多提宝贵意见。</h3><p>后面我会分享一些Retrofit配合Okhttp配合Stetho配合Chrome做网络调试的经验，以及Retrofit请求网络的速度对比分析。依然都会是一些入门的东西，意在让大家快速的用起来，而更深层次的东西，还需要大家自己多学习，多探讨。</p>
<p>最后的最后，也欢迎大家关注我们正在做的事儿：<a href="http://sj.qq.com/myapp/detail.htm?apkName=com.cxtimes.zhixue" target="_blank" rel="external">知学，一个大学生家教O2O平台</a>，当然这个App在制作上仍然有很多的不足，有希望大家多提宝贵意见。</p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/Andriod/">Andriod</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
      <div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=123456789012345";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

<div class="fb-comments" data-href="http://zijianwang.xyz/2015/05/22/Android-Dev-The-simple-user-of-Retrofit-Http-Client/index.html" data-num-posts="5" data-width="840" data-colorscheme="light"></div>
      
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:zijianwang.xyz">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">標籤</h3>
  <ul class="entry">
  
    <li><a href="/tags/Andriod/">Andriod</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Zijian Wang
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>