<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Cody.W的哈哈BLOG</title>
  <meta name="author" content="Zijian Wang">
  
  <meta name="description" content="暂无描述，哈">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Cody.W的哈哈BLOG"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Cody.W的哈哈BLOG" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

  
<script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fac7581aaee317d2fe1f7a0fc8d1f214";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Cody.W的哈哈BLOG</a></h1>
  <h2><a href="/">欢迎大家来讨论</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-05-28T18:40:11.000Z"><a href="/blog/Android-M-Auto-Backup-Runthrough/">2015-05-28</a></time>
      
      
  
    <h1 class="title"><a href="/blog/Android-M-Auto-Backup-Runthrough/">Andriod M新特性：应用数据自动备份之浅析</a></h1>
  

    </header>
    <div class="entry">
      
        <p>昨天晚上看完了IO 2015的Keynote，今天就来了官网看看有什么<a href="http://developer.android.com/preview/api-overview.html" target="_blank" rel="external">新API与新特性</a><br>目前来看，有三点：<a href="http://developer.android.com/preview/features/runtime-permissions.html" target="_blank" rel="external">Permissions</a>，<a href="http://developer.android.com/preview/features/app-linking.html" target="_blank" rel="external">App Links</a>，<a href="http://developer.android.com/preview/backup/index.html" target="_blank" rel="external">Auto Backup for Apps</a>。第一个是本次M的权限管理API，第二个是通过URL快速打开应用的相应API，而第三个，让我非常的感兴趣，那就是应用数据的自动备份。</p>
<p>而之所以对这个应用数据自动备份产生浓厚的兴趣，源于一个场景，那就是作为一个Nexus玩家，频繁的刷机是很正常的，而频繁刷机就面临一个问题，应用的备份以及数据的备份，我往往是通过钛备份备份，或者干脆不备份。</p>
<p>而此次的数据自动备份功能可以将应用的数据自动同步到Google Drive（意味着基本无缘天朝）。</p>
<h2 id="本人对自动功能的一些简单的总结：">本人对自动功能的一些简单的总结：</h2><ul>
<li>首先，自动备份功能会备份App的数据，自动上传到该设备登录用户的Google Drive里面（每个应用有最大25MB的存储空间），并且被这部分备份数据所占用的Google Drive控件不会算到你的付费控件之内，也就是这部分控件完全白送。</li>
<li>备份24小时内随时都可能会开始备份，但是<strong>只有当用户的设备满足空闲、充电、并且连接至WIFI</strong>，只有满足以上三个条件，Backup Manager才会将可备份文件上传到云端。当用户切换到新的设备，或者卸载重装应用，用户的数据都会被恢复到新的设备上。</li>
<li>当然，并非所有的数据都需要被备份，通过以下方法得到的目录，默认情况下都被指定为不备份目录：<a href="http://developer.android.com/reference/android/content/Context.html#getCacheDir%28%29" target="_blank" rel="external">getCacheDir()</a>, <a href="http://developer.android.com/reference/android/content/ContextWrapper.html#getCodeCacheDir%28%29" target="_blank" rel="external">getCodeCacheDir()</a>, <a href="http://developer.android.com/reference/android/content/Context.html#getExternalFilesDir%28java.lang.String%29" target="_blank" rel="external">getExternalFilesDir()</a>, <a href="http://developer.android.com/reference/android/content/Context.html#getNoBackupFilesDir%28%29" target="_blank" rel="external">getNoBackupFilesDir()</a>。</li>
</ul>
<h2 id="如何配置数据备份">如何配置数据备份</h2><p>对于在M Preview上安装的App，<strong>在默认情况下数据都会被备份</strong>。除了我们上述提到的一些目录，我们还可以通过Xml文件声明的形式进一步控制需要被备份的文件。配置方法大概如下：</p>
<p>首先在我们的Manifest清单文件中声明android:fullBackupContent并且配置相关的xml文件来决定什么文件备份或不备份。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">manifest</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">        <span class="attribute">xmlns:tools</span>=<span class="value">"http://schemas.android.com/tools"</span></span><br><span class="line">        <span class="attribute">package</span>=<span class="value">"com.my.appexample"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">uses-sdk</span> <span class="attribute">android:minSdkVersion</span>=<span class="value">"MNC"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">uses-sdk</span> <span class="attribute">android:targetSdkVersion</span>=<span class="value">"MNC"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">app</span> <span class="attribute">...</span></span><br><span class="line">        <span class="attribute">android:fullBackupContent</span>=<span class="value">"@xml/mybackupscheme"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">app</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="title">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>mybackupscheme.xml的位置位于res/xml下，配置方式大致如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">full-backup-content</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">exclude</span> <span class="attribute">domain</span>=<span class="value">"database"</span> <span class="attribute">path</span>=<span class="value">"device_info.db"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">full-backup-content</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="备份设置语法">备份设置语法</h2><p>首先需要明确的是，这个备份配置允许我们制定哪些文件需要被备份，哪些不需要</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">full-backup-content</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">include</span> <span class="attribute">domain</span>=<span class="value">["file"</span> | "<span class="attribute">database</span>" | "<span class="attribute">sharedpref</span>" | "<span class="attribute">external</span>" | "<span class="attribute">root</span>"] <span class="attribute">path</span>=<span class="value">"string"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">exclude</span> <span class="attribute">domain</span>=<span class="value">["file"</span> | "<span class="attribute">database</span>" | "<span class="attribute">sharedpref</span>" | "<span class="attribute">external</span>" | "<span class="attribute">root</span>"] <span class="attribute">path</span>=<span class="value">"string"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">full-backup-content</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以下是我们在备份配置文件中可以用到的元素：</p>
<figure class="highlight"><figcaption><span>指定哪些元素需要被备份，**一旦我们指定了这个标签，系统会只备份在这里声明的文件，而不会跟着系统默认走。**</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">```&#60;exclude&#62;``` &#25351;&#23450;&#21738;&#20123;&#19981;&#34987;&#31995;&#32479;&#33258;&#21160;&#22791;&#20221;&#10;```domain.``` &#25351;&#23450;&#34987;include&#25110;&#32773;exlude&#30340;&#36164;&#28304;&#31867;&#22411;&#65292;&#26377;&#20197;&#19979;&#20960;&#31181;&#65306;&#10;- ```root``` &#24212;&#29992;root&#30446;&#24405;&#19979;&#30340;&#36164;&#28304;&#10;- ```file``` &#36890;&#36807;[getFilesDir()][9]&#26041;&#27861;&#33021;&#22815;&#25343;&#21040;&#30340;&#36164;&#28304;&#10;- ```database``` &#36890;&#36807;[getDatabasePath()][10]&#26041;&#27861;&#25110;&#32773;&#36890;&#36807;[SQLiteOpenHelper][11]&#25343;&#21040;&#30340;&#25968;&#25454;&#24211;&#36164;&#28304;&#10;- ```sharedpref``` &#36890;&#36807;[getSharedPreferences()][12]&#26041;&#27861;&#33021;&#22815;&#25343;&#21040;&#30340;[SharedPreferences][13]&#23545;&#35937;&#21450;&#25968;&#25454;&#10;- ```external``` &#36890;&#36807;[getExternalFilesDir()][7]&#26041;&#27861;&#33021;&#25343;&#21040;&#30340;&#22806;&#37096;&#23384;&#20648;&#30446;&#24405;&#19979;&#30340;&#36164;&#28304;&#10;- ```path``` &#36890;&#36807;&#25105;&#20204;&#25163;&#21160;&#25351;&#23450;&#30340;&#30446;&#24405;&#10;&#10;&#10;##&#31105;&#27490;&#33258;&#21160;&#22791;&#20221;&#10;&#24403;&#28982;&#25105;&#20204;&#21516;&#26679;&#33021;&#22815;&#31105;&#27490;&#31995;&#32479;&#23558;&#24212;&#29992;&#25968;&#25454;&#22791;&#20221;&#21040;&#35895;&#27468;&#20113;&#31471;&#30828;&#30424;&#65292;&#37197;&#32622;&#20063;&#24456;&#31616;&#21333;&#65292;&#21482;&#35201;&#22312;Manifest&#25991;&#20214;&#20013;&#20570;&#20986;&#22914;&#19979;&#37197;&#32622;&#21363;&#21487;&#10;&#10;```xml&#10;&#60;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&#62;&#10;&#60;manifest xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34;&#10;        xmlns:tools=&#34;http://schemas.android.com/tools&#34;&#10;        package=&#34;com.my.appexample&#34;&#62;&#10;    &#60;uses-sdk android:minSdkVersion=&#34;MNC&#34;/&#62;&#10;    &#60;uses-sdk android:targetSdkVersion=&#34;MNC&#34;/&#62;&#10;    &#60;app ...&#10;        android:allowBackup=&#34;false&#34;&#62;&#10;    &#60;/app&#62;&#10;    ...&#10;&#60;/manifest&#62;</span><br></pre></td></tr></table></figure>
<p>以上，为大家简单介绍了Android M中的全新特性，应用数据自动备份。相信大家也对其有了一定的了解。进一步的信息大家可以移步官方文档，在官方文档中还涉及到了如何调试应用数据备份功能。随着Android M的正式发布，API文档也许会发生一定的变化。</p>
<p>大家也可以<a href="https://github.com/googlesamples/android-AutoBackupForApps" target="_blank" rel="external">移步这里</a>，来查看谷歌官方的自动备份demo</p>
<p>最后的最后，在观看了此次2015 IO大会的Keynote之后，也深深感慨谷歌有这么多强大的API，强大的功能，Google Now，Wear等等等，而国内的安卓开发者却有很多都感受不到</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-05-26T16:02:24.000Z"><a href="/blog/Android-How-to-get-response-JSON-in-Retrofit/">2015-05-26</a></time>
      
      
  
    <h1 class="title"><a href="/blog/Android-How-to-get-response-JSON-in-Retrofit/">如何使用Retrofit获取服务器返回来的JSON字符串</a></h1>
  

    </header>
    <div class="entry">
      
        <p>有关Retrofit的简单集成攻略，大家可以参考我此前的一篇文章<br>有关更多API文档的查阅请大家到<a href="http://square.github.io/retrofit/" target="_blank" rel="external">Retrofit官网</a>查看。</p>
<p>在大家使用网络请求的时候，往往会出现一种情况：需要在拿到服务器返回来的JSON字符串，而Retrofit会默认将Json解析，而又没有直接暴露出拿到Json字符串的方法，经过在网上一定的查阅，再次给大家一个简单的办法，就能够拿到Json字符串。</p>
<p>以下是我们在Api接口中的定义方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以前我们使用我们定义好的POJO或javabean类作为callback的泛型，以便Retrofit帮我们解析</span></span><br><span class="line"><span class="annotation">@POST</span>(<span class="string">"/interface/xxxxxx"</span>)</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getCouponList</span><span class="params">(Callback&lt;Coupon&gt; reponse)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//但如果我们想获得JSON字符串，Callback的泛型里就不能写POJO类了，要写Response（retrofit.client包下）</span></span><br><span class="line"><span class="annotation">@POST</span>(<span class="string">"/interface/xxxxxx"</span>)</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getCouponList</span><span class="params">(Callback&lt;Response&gt; reponse)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>那么在我们请求接口的时候，只需简单一行代码，就能拿到服务器返回的JSON字符串了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ZhixueApiUtil.getInstance().getZhixueApi().getCouponList(<span class="keyword">new</span> Callback&lt;Response&gt;() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">success</span><span class="params">(Response response, Response response1)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//注意这里用第一个Response参数的</span></span><br><span class="line">        String jsonString = <span class="keyword">new</span> String(((TypedByteArray) response.getBody()).getBytes());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//再使用Retrofit自带的JSON解析（或者别的什么）</span></span><br><span class="line">        Coupon coupon = <span class="keyword">new</span> Gson().fromJson(jsonString, Coupon.class);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failure</span><span class="params">(RetrofitError error)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>至此，我们就能拿到JSON字符串了，在需要的时候可以用这种办法。<br>当然，也希望Retrofit以后能够加入相应的API。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-05-22T23:49:54.000Z"><a href="/blog/Android-Dev-The-simple-user-of-Retrofit-Http-Client/">2015-05-22</a></time>
      
      
  
    <h1 class="title"><a href="/blog/Android-Dev-The-simple-user-of-Retrofit-Http-Client/">Andriod集成Retrofit网络请求库指南</a></h1>
  

    </header>
    <div class="entry">
      
        <p>近期我在我们的项目中大量的集成了Retrofit网络请求框架，经过了对Retrofit几天的了解，感觉这个库确实很强大很好用。</p>
<p>而鉴于目前网上一些中文Retrofit的指南我个人认为都不是很详尽（大多只是将官方文档用中文翻译了一下），即便是Retrofit官方指南也没有把大家可能常用到的API解释详尽。</p>
<p>所以本文意在给大家更加详细的讲解如何简单的使用Retrofit。鉴于本人技术有限，对Retrofit的实现原理以及源码等分析做的并不透彻，只是向大家简要介绍Retrofit的使用，使得像我一样的新手能够快速的上手入门。也希望大家向我提出宝贵的意见。</p>
<hr>
<p>有关更多API文档的查阅请大家到<a href="http://square.github.io/retrofit/" target="_blank" rel="external">Retrofit官网</a>查看。</p>
<p>首先咱先把Retrofit集成到项目中来:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">'com.squareup.retrofit:retrofit:1.9.0'</span></span><br></pre></td></tr></table></figure></p>
<p>以下，我将以我们的产品“<a href="http://sj.qq.com/myapp/detail.htm?apkName=com.cxtimes.zhixue" target="_blank" rel="external">知学</a>”中所用到的一些网络请求来为大家阐述Retrofit的简单使用。</p>
<p>对Retrofit而言，有两个类是非常关键的，那就是RestAdapter和我们自定义的接口（在知学中叫做ZhixueApi），前者的的作用有很多，但我们我们必然会用到的就是<strong>指定我们请求网络的主域名</strong>。而后者则负责封装我们在项目中要用到的每一个接口。</p>
<p>首先我们来简单了解下关于ZhixueApi的定义。在这个类中，我会介绍我们用到的几种提交方式以及参数的拼装形式。</p>
<p>另外，在我们的应用中并没有用到GET提交方式，有关的信息在官方指南中也阐述的比较清晰，本文便不在单独讨论GET提交方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ZhixueApi</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//1. 无参数post请求, 这里的Coupon则是用来解析服务器返回Json字符串的javabean类, Retrofit默认使用Gson解析</span></span><br><span class="line">	<span class="annotation">@POST</span>(<span class="string">"/interface/xxxxxx"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">getCouponList</span><span class="params">(Callback&lt;Coupon&gt; reponse)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2. 一个或几个参数的post请求</span></span><br><span class="line">	<span class="comment">// 注: 如果使用官方指南中提到的@Query和@QueryMap对参数进行封装, 那么默认会将参数拼到URL之中</span></span><br><span class="line">	<span class="comment">// 首先并不建议将参数拼如URL, 其次由于编码原因, 如果选择采用@Query或者@QueryMap类型的注解, 则参数中必然不能有中文</span></span><br><span class="line">	<span class="comment">// 其次如果使用@Query或者@QueryMap, 也就不能使用@FormUrlEncoded注解, 否则参数会消失</span></span><br><span class="line">	<span class="comment">// 如果使用了@FormUrlEncoded注解, 则必须使用@Field或者@FieldMap注解来作为参数</span></span><br><span class="line">	<span class="annotation">@FormUrlEncoded</span></span><br><span class="line">   	<span class="annotation">@POST</span>(<span class="string">"/interface/xxxxxx"</span>)</span><br><span class="line">   	<span class="function"><span class="keyword">void</span> <span class="title">getCourseList</span><span class="params">(@Field(<span class="string">"userId"</span>)</span> String userId, @<span class="title">Field</span><span class="params">(<span class="string">"orderId"</span>)</span> String orderId, Callback&lt;Coupon&gt; response)</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//3. 通过@FieldMap注解来封装参数</span></span><br><span class="line">	<span class="comment">//注: 如果你的参数只有一个或者两三个, 那么用@Field就基本足够了, 但如果你的参数非常之多, 七八个甚至十几个</span></span><br><span class="line">	<span class="comment">//那么我们就可以用一个Map去封装, 通过key-value的形式封装好Map对象后再传入, 代码会相对整洁, 在做参数传递的时候也不至于乱套</span></span><br><span class="line">	<span class="annotation">@FormUrlEncoded</span></span><br><span class="line">	<span class="annotation">@POST</span>(<span class="string">"/interface/xxxxxx"</span>)</span><br><span class="line">   	<span class="function"><span class="keyword">void</span> <span class="title">getCourseList</span><span class="params">(@FieldMap Map&lt;String,String&gt; paramsMap, Callback&lt;Coupon&gt; response)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//4. 提交multipart请求</span></span><br><span class="line">	<span class="comment">// 注: 如果我们要提交用户拍的的照片, 或者是录好的语音, 那么我们就要用到@Multipart这个注解了</span></span><br><span class="line">	<span class="comment">// 在使用Multipart的时候, 注意参数的注解必须是@Part或者@PartMap </span></span><br><span class="line">	<span class="comment">// @PartMap和上面的@FieldMap类似, 都是通过Map封装好参数, 就不过多解释了.</span></span><br><span class="line">	<span class="annotation">@Multipart</span></span><br><span class="line">   	<span class="annotation">@POST</span>(<span class="string">"/interface/photoUpload_servlet"</span>)</span><br><span class="line">   	<span class="function"><span class="keyword">void</span> <span class="title">submitUserPhoto</span><span class="params">(@Part(<span class="string">"userId"</span>)</span> String userId, @<span class="title">Part</span><span class="params">(<span class="string">"file"</span>)</span> TypedFile file, Callback&lt;Coupon&gt; response response)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而对于上传文件, 我们需要将我们所需上传的File文件转换成TypedFile形式, 在Retrofit中也很简单<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//首先定义一个mimeType类型, 如果我要上传的是一张图片, 就按如下定义</span></span><br><span class="line">String mimeType = <span class="string">"image/jpg"</span>;</span><br><span class="line"><span class="comment">//String mimeType = "audio/m4a";//如果是m4a的声音文件, 就这么定义</span></span><br><span class="line">TypedFile typedFile = <span class="keyword">new</span> TypedFile(mimeType, file);<span class="comment">//调用这个方法将文件转为TypedFile形势, 传参上传即可</span></span><br></pre></td></tr></table></figure></p>
<p>以下这个类是我封装的ZhixueApiUtil，作用是在每次请求接口的时候能够快速的拿到ZhixueApi的实例，所以我在此设计了一个简单的单例模式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZhixueApiUtil</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ZhixueApiUtil mInstance;</span><br><span class="line">	<span class="comment">//此前定义的接口的实例</span></span><br><span class="line">	<span class="keyword">private</span> ZhixueApi zhixueApi;</span><br><span class="line">	<span class="comment">//我们的主域名</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST = <span class="string">"http://111.111.111.111"</span>;</span><br><span class="line">	<span class="comment">//构造函数</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">ZhixueApiUtil</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//在构造函数中我们要通过实例化RestAdapter拿到我们的ZhixueApi</span></span><br><span class="line">		<span class="comment">//注: setRequestInterceptor()在这里是为了在请求头中加入设备信息, 方便我们后台的调试</span></span><br><span class="line">		RestAdapter restAdapter = <span class="keyword">new</span> RestAdapter.Builder().setRequestInterceptor(defaultInterceptor).setEndpoint(HOST).build();</span><br><span class="line">		zhixueApi = restAdapter.create(ZhixueApi.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//一个简单的单例</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZhixueApiUtil <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">			mInstance = <span class="keyword">new</span> ZhixueApiUtil();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> mInstance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ZhixueApi <span class="title">getZhixueApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> zhixueApi;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//在这里我们还定义了一个RequestInterceptor, 作用是在请求头中拼入一些信息方便我们后台的调试</span></span><br><span class="line">	<span class="comment">//否则请求头中就只会出现okhttp 2.2.0的字样(Retrofit默认是直接使用OkhttpClient的)</span></span><br><span class="line">	RequestInterceptor defaultInterceptor = <span class="keyword">new</span> RequestInterceptor() &#123;</span><br><span class="line">		<span class="annotation">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">intercept</span><span class="params">(RequestFacade request)</span> </span>&#123;</span><br><span class="line">			request.addHeader(<span class="string">"User-Agent"</span>, <span class="string">"some code here"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而当我们手握这两个类的时候, 请求接口就会变得异常的简单<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//例如</span></span><br><span class="line"></span><br><span class="line">ZhixueApiUtil.getInstance().getZhixueApi().getCourseList(paramsMap, <span class="keyword">new</span> Callback&lt;Coupon&gt;()&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">success</span><span class="params">(Coupon coupn, Response response)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//在这里Json已经通过Retrofit中含有的Gson包为我们解析好了, 直接拿出来用就好了!</span></span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failure</span><span class="params">(RetrofitError error)</span> </span>&#123;</span><br><span class="line">		Log.d(TAG, error.getMessage());</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="到这里，相信大家已经能够基本使用Retrofit了，本人代码经验尚浅，文中有什么不足希望大家多提宝贵意见。">到这里，相信大家已经能够基本使用Retrofit了，本人代码经验尚浅，文中有什么不足希望大家多提宝贵意见。</h3><p>后面我会分享一些Retrofit配合Okhttp配合Stetho配合Chrome做网络调试的经验，以及Retrofit请求网络的速度对比分析。依然都会是一些入门的东西，意在让大家快速的用起来，而更深层次的东西，还需要大家自己多学习，多探讨。</p>
<p>最后的最后，也欢迎大家关注我们正在做的事儿：<a href="http://sj.qq.com/myapp/detail.htm?apkName=com.cxtimes.zhixue" target="_blank" rel="external">知学，一个大学生家教O2O平台</a>，当然这个App在制作上仍然有很多的不足，有希望大家多提宝贵意见。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:zijianwang.xyz">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/Android/">Android</a><small>3</small></li>
  
    <li><a href="/tags/Android-M/">Android M</a><small>1</small></li>
  
    <li><a href="/tags/Auto-Backup/">Auto Backup</a><small>1</small></li>
  
    <li><a href="/tags/Retrofit/">Retrofit</a><small>2</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Zijian Wang
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>